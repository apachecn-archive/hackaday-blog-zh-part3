# 入侵检验显微镜

> 原文:[https://hack aday . com/2017/06/26/hacking-an-inspection-microscope/](https://hackaday.com/2017/06/26/hacking-an-inspection-microscope/)

有时我需要能够拍摄非常小的东西，而我的傻瓜相机上所谓的微距模式无法满足我的要求。对于微小的焊接工作，手边有一个检查镜也不会有什么坏处，尽管对于大多数任务，我更喜欢一只眼睛里有一个简单的珠宝商放大镜。因此，我给我的密友阿里巴巴寄去了 40 多美元，几周后，我自豪地拥有了一台可使用一半的检查镜，它可以将照片或视频记录到 SD 卡上。

不幸的是，由于低劣的界面设计和不稳定的安装，它只能使用一半。所以我花了一个下午，把显微镜拆开，让它在微控制器的控制下，配有 WiFi 和脚本语言。好多了！现在我可以用显微镜计时，但更重要的是，我可以拍出没有模糊的照片，而不用触摸晃动的装置。这是一个有趣的黑客，所以我想我会分享。请继续阅读！

## 非常好

[![](../Images/c36474e105f1854dd576e890a0157df8.png)](https://hackaday.com/wp-content/uploads/2017/06/dscf9839.jpg)

Nice image, but don’t touch!

范围，因为它到达，真的很有趣。图像很好，几乎一切都像广告宣传的那样。至少在几个小时内，观察昆虫和花朵是有益的。然而，所有有助于愉悦用户体验的小细节都被搞糟了。

例如，SD 卡上的间隙非常小，如果没有薄的东西压进去，或者指甲很长，你就无法插入或取出它。大对焦旋钮后面的一些按钮很难够到。菜单系统，例如打开或关闭 LED 环形灯，是可怕的。这些都是小问题，为了代价，我完全愿意忽略它们。

但对我来说，致命的是支架太不稳定了，以至于按下“确定”按钮拍照的动作模糊了那里的图像。视频模式有一个“运动检测”方法——它总是打开，因为摄像机抖动得太厉害，它总是认为对象刚刚移动过。罪魁祸首是劣质的框架，末端是厚厚的硅胶吸盘，像一碗果冻一样晃动。这是*而不是*你如何设计三脚架。

振动问题有两种可能的解决方法。首先是建立一个更好的框架，这是我最终可能会做的事情，因为检查范围*是*一个有用的齿轮。另一个解决方案是简单地触发曝光(和其他)按钮，而不要碰到扭动的小怪兽。欢迎来到显微镜互联网！

## 黑，黑，黑

[![](../Images/2a32057c476351b95645808fe31c6217.png)T2】](https://hackaday.com/wp-content/uploads/2017/06/dscf9860_thumbnail.png)

打开机箱，我首先发现的是键盘上的一排五个测试点，所以我焊接了一些头线，看看发生了什么。(那很容易！)它们被贴上了`GND`、`VCC`、`KEY`、`PWR`和`VBAT`的标签，这并没有给人们留下多少想象的空间。五分之四的标签是正确的。

我本质上是一个模拟黑客，当探索未知信号时，我通常从示波器开始，但这次我决定从逻辑探针开始，因为肯定是一根`KEY`线以某种数字代码对五个前面板按钮进行了编码。想象一下，当每个按钮在逻辑嗅探器上看起来都一样时，我有多惊讶。又被烧了。回到可靠的示波器。

[![](../Images/29a7a7971bc72fc11187e7931a139a00.png)](https://hackaday.com/wp-content/uploads/2017/06/scope_195.png)

Five buttons, five voltages

原来，这五个按钮被连接到五个不同的电阻，这些电阻充当了一个[分压器](https://en.wikipedia.org/wiki/Voltage_divider)的下半部分，一个 ADC 读取这个电压来计算出哪个键被按下了。这解释了黄色示波器描迹上的五个电压电平。

这是一个经典的卑鄙伎俩，我一直在等待着有一天，我绝对要尽量减少连接到面板的电线数量。谁知道我会在实际的产品中看到这样的东西呢？

电源按钮是独立的，将`PWR`线(示波器描迹上的绿色，垂直刻度为 5 V)拉到`VBAT`线上。使用 3.3 V 电源进行的快速测试使我相信，我可以使用微控制器的 GPIO 来打开和关闭该设备。我还非常确定，我可以将五个 GPIO 引脚连接到不同的电阻上，并“按下”相应的按钮。所以我拉下面板来测量单个电阻。

[![](../Images/732788ed87c0e86cbe79c31ab42cb14d.png)](https://hackaday.com/wp-content/uploads/2017/06/dscf9853.jpg) 如果您想在家中复制这种情况，电阻分别为 0ω、15kω、30kω、46.6kω和 70kω，稍微计算一下测得的电压，分压器顶部的上拉电阻可能标称值为 100kω。或者，如果您有一个 DAC，您可以将 0 V、400 mV、750 mV、975 mV 或 1325 mV 的电压发送到`KEY`引脚。我焊接了我盒子里最接近的电阻，确认它们都工作正常，然后称硬件完成。

但是`VCC`线是怎么回事？有些事情没有意义，因为按钮尽管连接到`VCC`但还是拉低了电压，`KEY`线默认拉高。测试一下，当然`VCC`是对`GND`的完全短路，上拉电阻在`KEY`线上。键盘面板 PCB 上也有一个未填充的电阻，这表明在以前的版本中，按钮上拉，但制造商通过使用微控制器的内部上拉优化掉了一个电阻。他们没有换考点丝印来配合，不是懒惰就是故意破坏。(想象一下，将您的测试设备连接到“`VCC`”和`GND`会有多有趣！)

## 通常的嫌疑人

剩下的工作只是我使用我最喜欢的工具来快速完成这样的工作。你可能想使用 Arduino 或单个 ESP8266，但我最近一直在用廉价的 STM32F103 板玩 [Mecrisp-Stellaris Forth，所以我去了那里。我最初想做一个定制的远程键盘，所以许多 GPIO 引脚意味着我不必求助于 ADC 和电阻的技巧。](http://hackaday.com/2017/04/19/moving-forth-with-mecrisp-stellaris-and-embello/)

[![](../Images/b1b612e0bbdf88b4daa3c75a9305b86b.png)](https://hackaday.com/wp-content/uploads/2017/06/dscf9866.jpg) 我当时已经在用 UART 串口进行编程和调试了，认定一个单独的按键面板本身就是一个项目，于是我就埋头苦干，把显微镜放到了 WiFi 网络上。我用[esp-link](https://github.com/jeelabs/esp-link)WiFi-串行桥固件刷新了一个 ESP8266。瞧，遥控器。当我必须在桌子上移动它时，从显微镜的`VBAT`线上给微控制器供电(通过一个开关)使整个东西完全独立。

有许多细节需要反复试验才能正确。例如，在相机模式和菜单系统中，按下按钮需要不同的延迟。我没有优化这些，但使延迟足够长，它总是工作。电源开关按钮只有在按住超过 1.5 秒的情况下才有效。很奇怪。对于像 Forth environment 这样的交互式调试系统来说，这一切都非常快，尽管我不认为在 C 或 Arduino 这样的编译-刷新循环中会有多糟糕。

[![](../Images/60c4287fe44b2efce4fbff46bb0b2976.png)](https://hackaday.com/wp-content/uploads/2017/06/dscf9851.jpg)

More guts, just for completeness

我在固件里做的有两件可爱的事值得一提。用于检测按钮按压的`KEY`线仅在显微镜通电时被拉起，因此它可以被微控制器读取，以确定显微镜当前是开着还是关着。当显微镜第一次打开时，它处于视频模式，这允许软件在内部跟踪它当前所处的模式。

结合起来，这允许一个单一的“拍摄”命令，首先验证显微镜是打开的，然后切换到相机模式，如果它还没有，然后最后拍照。类似地，“删除”命令切换到预览模式并删除最后一张照片，确认所有的“你确定吗？”自动对话。如果你感兴趣的话，代码在这里。

## 让它变得可用

开箱即用的菜单系统太恐怖了。它需要大约 15 次按键来打开或关闭环形灯。在微控制器中编写脚本会让事情变得更加愉快。此外，现在可以设置重复曝光来进行延时，或者每十分钟拍摄一次两分钟的视频，或者基本上自动化任何事情。我可能会添加一个距离传感器，当镜头下有印刷电路板时，自动拍摄，或者做一些愚蠢的事情。我非常喜欢将这些脚本功能绑定到外部按钮的想法:一键灯光开关或括号曝光按钮会很好，单键删除也会很好。

 [https://www.youtube.com/embed/tl2wjcNPsL4?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent](https://www.youtube.com/embed/tl2wjcNPsL4?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent)

T2】

世界现在是我的了，所以期待在即将到来的 Hackaday 文章中看到更多的超级特写镜头。如果你拿起一台这样的显微镜，不要犹豫，打开它，焊上一把电阻，自己控制它。你可能会发现它足够有用，你会建立一个适当的立场，但这是另一个故事。