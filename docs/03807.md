# 宋承宪进入 Mosh 坑

> 原文:[https://hackaday.com/2016/11/01/ssh-enters-the-mosh-pit/](https://hackaday.com/2016/11/01/ssh-enters-the-mosh-pit/)

由于如此多的系统依赖于 Linux，安全 shell SSH 已经成为许多开发人员的必备工具。如果您通过几英尺外的电缆或无线路由器连接到您的 Raspberry Pi，SSH 可以为您提供直接到机器的加密连接。然而，如果您的系统在一片沼泽中，网络访问时断时续，SSH 可能是一个真正的麻烦。当您的 IP 地址可能改变时(例如，在蜂窝网络上漫游)，SSH 也会有问题。

为了解决这些和其他问题，你可以考虑一个叫做 [Mosh](https://mosh.org) (移动外壳)的开源程序。Mosh 有两个部分。一部分作为服务器工作，而另一部分是客户端应用程序。这两者都不需要 root 访问权限。下面可以看到一个关于 Mosh 的视频。

使用 Mosh 与使用 SSH 非常相似(事实上，您可以使用 SSH 来启动 Mosh)。Mosh 服务器有一个同步屏幕的系统，所以它不会浪费时间发送不会真正出现在用户面前的字符。此外，客户端保留自己的屏幕概念，并尝试在本地处理一些操作。例如，在 SSH 中，你输入的每一个字符都会通过服务器得到回应。虽然这有助于了解服务器的存在，但对响应速度却没有好处。Mosh 在本地处理 echo，并预测某些事情，如字符的插入和删除。与 SSH 不同，Mosh 使用 UDP 数据报，因此数据包丢失不是什么大问题。

事实上，如果你切换网络或者你的电脑睡眠和唤醒，Mosh 将保持“连接”因为 Mosh 不会发送你看不到的数据，所以你可以很容易地中断长时间的滚动输出(Mosh 根据网络连接的质量选择滚动的帧速率)。

## 看到未来

当你在 Mosh 中输入一些东西时，它可能会做出预测。如果网络不稳定，Mosh 会认为大多数字符会出现在当前光标位置。它还期望某些键的行为，如退格键、右箭头键和左箭头键。当然，也有可能是错的，所以在猜测被证明是对的之前，它会强调这些猜测。软件收集成批的预测输入(时期),并将其作为一个组进行验证(或拒绝)。某些字符(如上下箭头)启发性地开始新的纪元。

例如，如果您开始在 emacs(或 vi)中键入，您将开始构建一个不在屏幕上显示的纪元。当数据从验证猜测正确的主机返回时，Mosh 将显示纪元，并继续显示其猜测，直到某个东西(如向上或向下箭头)改变了纪元。那么它将返回到不执行本地回声，直到它再次正确预测。所有这些都运行良好，但是如果您愿意，可以关闭预测。

如果您想直接看到这种行为，可以打开一个 Mosh 会话，并在 shell 提示符下开始输入。例如，假设您要输入以下命令:

```
find / -name 'mosh*' -print
```

键入到第一个斜杠。现在断开网络连接(拔掉电缆或关闭无线网络)。键入更多的命令，您会看到投机字符显示下划线(见下文；红色光标表示连接当前未启动)。现在，要么重新连接网络，要么打开手机的热点，要么连接到不同的网络。输入完命令后，它应该就可以工作了。

[![mosh](../Images/7fd2248ab681760c52b1f0d2d341abe7.png)T2】](https://hackaday.com/wp-content/uploads/2016/10/mosh.png)

## 厨房同步

Mosh 还声称解决了许多其他显示相关的问题，这些问题源于 Unicode 和转义字符的使用。然而，真正的引擎是同步部分，它实际上可以使任何抽象对象在两个设备之间保持同步。Mosh 使用这种同步协议(SSP)的两个实例；一个用来保存屏幕缓冲区，一个用来处理输入缓冲区。事实是，Mosh 只是一个构建在 SSP 之上的终端仿真器。SSP 似乎可以在其他需要两台机器在低质量网络上保持同步的应用中找到用途。

Mosh 可以在数量惊人的平台上使用。除了通常的怀疑之外，你可以在 Android 上获得作为 JuiceSSH 客户端一部分的 Mosh。Windows 用户可以使用 Cygwin 或在 Chrome 中运行的版本。它也可以运行在 Mac 或任何几个 Linux 和 BSD 发行版上。当然，您也可以从源代码构建它。在 Raspian 上安装它就像发出通常的命令一样简单:

```
sudo apt-get install mosh
```

如果你只是一个桌面或服务器 Linux 用户，你可能永远不会关心 Mosh。但是，如果您将系统部署到网络连接不稳定或变化的地方，就值得一看。更重要的是，如果您需要在两个不同的计算机之间保持任意对象的同步，尽管网络很差，那么您真的应该检查一下 SSP，看看您是否可以按照自己的意愿改变它。

 [https://www.youtube.com/embed/XsIxNYl0oyU?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent](https://www.youtube.com/embed/XsIxNYl0oyU?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent)

T2】