# 最小 MQTT:构建代理

> 原文：<https://hackaday.com/2016/05/09/minimal-mqtt-building-a-broker/>

在这个简短的系列中，我们将让您使用 MQTT 建立一个完全 DIY 的家庭自动化系统。为什么？因为这几乎是世界上最简单的事情，而且这是你们中的许多人能够利用手头的材料完成的事情:一个作为服务器的 Raspberry Pi 和一个作为传感器客户端的 ESP8266 节点。扩展到更复杂的东西是留给有动力的读者的一个练习，或者可以简单地留给任务蠕变。

我们将分四步走。每一个应该只花你十五分钟，是完全独立的。你还可以学习和探索更多的东西，但是我们会让你以最少的麻烦体验到它的强大。

在这一期中，我们将在 Raspberry Pi 上构建一个代理，它是 MQTT 网络的中枢。下一次，我们将启动并运行 ESP8266，并开始记录一些数据。之后，我们将使用 Python 编写一些后端脚本来让数据说话，在最后一部分中，我们将探索一些有用的装饰和奇特之处。我们开始吧！

## 概观

MQTT 是一个发布-订阅、存储-转发、支持物联网的机器对机器连接协议巨头。如你所见，它完全符合流行词。不过，这并不一定意味着它超级复杂。你可以阅读 MQTT 直到[你脸色发青](http://www.hivemq.com/mqtt-essentials/)。这里是你需要知道的最起码的舒适。

网络有客户端(称为“客户机”)和服务器(称为“代理”)。客户端，无论是您的温度传感器节点还是将要使用数据的图形应用程序，都使用代理作为中心枢纽。数据排列在“主题”中，主题使用类似目录的结构。所以我卧室的温度节点叫做“家/卧室/温度”。当我在卧室节点上添加一个光线传感器的时候，我会设置一个名为“家/卧室/光线”之类的主题。

当客户端获得一些新数据时，它会将数据“发布”到主题，也就是将数据发送到服务器。然后，服务器将数据转发给“订阅”该主题的所有其他客户端。在我的例子中，bedroom 节点发布到“home/bedroom/temp ”,然后作为“home/bedroom/temp”订户的数据库程序自动接收它。订阅该主题的任何其他客户端也是如此。通常，给定的物理设备会订阅一些主题并发布给其他人。例如，我的加热控制器想要作用于温度传感器，并在卧室的 LED 上显示其状态。当然还有更多要说的，但是让我们先启动并运行我们的代理，稍后再探讨细节。

## 建立一个经纪人

![attachment_69370628](img/4b599488acd5e65156a82b00bc8ce523.png)好吧，“构建”有点言过其实。我们只是要下载`mosquitto`，这是最广泛使用的代理。如果您有一台 Raspberry Pi(或其他备用计算机)，那么您就有了一个 MQTT 代理。不幸的是，Raspbian 默认带有一个旧版本的 mosquitto，所以我们必须多输入一点才能得到最新的版本。下面是我如何在一个全新的 Raspberry Pi (Jessie Lite)上设置一个全功能的 MQTT 代理:

```

curl -O http://repo.mosquitto.org/debian/mosquitto-repo.gpg.key
sudo apt-key add mosquitto-repo.gpg.key
rm mosquitto-repo.gpg.key
cd /etc/apt/sources.list.d/
sudo curl -O http://repo.mosquitto.org/debian/mosquitto-jessie.list
sudo apt-get update
sudo apt-get install mosquitto mosquitto-clients

```

就这样。稍后，当我们需要从外部访问代理时，我们需要知道 Raspberry Pi 的 IP 地址，但仅此而已。你站起来了。如果您使用的是旧版本的 Raspbian，请将第五行中的“jessie”替换为“wheezy”。如果你使用的不是树莓 Pi，你可能会找到你需要的东西，包括 Windows 二进制文件。(我没有测试过 Windows 或者 Mac。)

## 四处玩耍

现在我们的代理已经设置好了，让我们做一些快速的实验来体验一下 MQTT 在实践中是如何工作的。你们当中精明的注意到我也装了`mosquitto-clients`。让我们试用一下。

打开一个窗口，输入`mosquitto_sub -h localhost -t "test/topic"`。祝贺您，您刚刚为客户订阅了“测试/主题”主题。`-h localhost`将您连接到本地机器上的 MQTT 服务器，而不是更广泛的互联网上。如果我们没有建立自己的服务器，我会让你指向[MQTT 测试服务器](http://test.mosquitto.org/)。事实上，当你需要他们的时候，我会让你知道他们就在那里。

好了，我们公布第一个数据吧。打开另一个窗口，键入`mosquitto_pub -h localhost -t "test/topic" -m "hello!"`相同的服务器，相同的主题，但现在我们正在发送一条消息。您应该会看到消息立即在订阅窗口中弹出。

尝试打开多个订阅同一主题的订阅者窗口。你会看到他们都明白了。尝试向尚不存在的主题发送消息。会发生什么？

在我们进入重要内容之前，最后一个愚蠢的 MQTT 技巧。MQTT 可以在主题名称中使用两种不同类型的通配符。所以我的网络有“家/卧室/临时”和“家/地下室/临时”主题。我可以通过订阅“home/+/temp”来读取所有温度，并从“home/bedroom/#”中获取我的卧室节点的所有值。(“+”匹配一个层次级别，而“#”代表树中更深层次的所有内容。)一旦你开始使用通配符，你会想知道哪个主题正在报告，所以尝试以详细模式`mosquitto_sub -h localhost -v -t "test/#"`订阅，并给自己发送一些不同主题的测试消息。

## 服务质量

这是 MQTT 针对低功耗家庭自动化传感器网络的杀手锏:它是一种“存储和转发”协议，具有几级服务质量(QOS)保证。如果您的节点已经向代理注册，并且当新消息进入时它处于离线状态，代理可以在节点重新连接时立即将该消息传递给该节点。这意味着您的节点可以在深度睡眠中度过大部分时间，节省电池电量，当它们最终连接时，它们不会错过任何东西。

QOS 功能需要三样东西:订阅客户端需要事先通过 ID 向服务器注册，并且它们需要禁用(默认)清除行为，否则当您重新登录时，所有存储的消息都会被删除。*订阅者和发布者都需要使用一级或二级服务质量，以便服务器知道这是一条存储的消息。(QOS 一级通常就够了，不过可以随意[读起](http://www.hivemq.com/blog/mqtt-essentials-part-6-mqtt-quality-of-service-levels)。)*

这里有一个例子:

```

subscriber:  
    mosquitto_sub -h localhost -v -t "test/#" -c -q 1 -i "james bond"
publisher:
    mosquitto_pub -h localhost -t "test/topic" -m "wowie" -q 1
    mosquitto_pub -h localhost -t "test/topic" -m "zowie"

```

为了演示 QOS 做了什么，在一个窗口中运行订户的命令，并向它发送另外两条消息。你会得到他们两个。现在用 ctrl-c 停止订阅者并重新发送两条消息。现在，当你再次订阅时，你只会得到“哇”，因为这是在启用 QOS 的情况下发送的消息。

使用 IDs 的一个问题是，你只能得到在次 id 登录之间*发生的事情。您必须事先向服务器注册，以便它为您保存邮件。你不能走进去，给它一个新的 ID，然后说“我错过了什么？”因为它还不了解你。*

还要注意，订阅者必须做三件事才能使用 QOS 接收消息。本我和 QOS 的水平是显而易见的。我经常忘记的一点是用`-c`标志禁用干净登录。别忘了。

## 保留的邮件

如果您不需要获得自您的节点上次联机以来的全部消息历史，请考虑“保留”标志。当消息作为保留消息发送时，最后一条这样的消息会自动传输到订阅该主题的任何客户端。保留的消息对于像状态报告这样的事情非常有用。任何时候，如果您想登录并只查看最后一个值而不必等待更新，您会希望您已经设置了 retain。请注意，保留的消息和 QOS 并不具有排他性，只是要小心，因为您会将一条消息(最新的一条)发送两次。

## 更多？？

这只是体验了运行自己的 MQTT 服务器的强大功能。接下来，我们将一些小型设备连接到网络，然后我们将构建一些后端处理。如果你已经走了这么远，已经等不及了，试着玩一下`mosquitto_sub -h test.mosquitto.org -t "hackaday/new_articles" -c -q 1 -i "your_name_here"`。该流使用`QOS=1`发布，并保留最后一条消息。请随意发挥，并在评论中向我们展示你的成果。