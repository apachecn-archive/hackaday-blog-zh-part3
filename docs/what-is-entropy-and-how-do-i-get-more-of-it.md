# 什么是熵，我如何得到更多的熵？

> 原文：<https://hackaday.com/2017/11/02/what-is-entropy-and-how-do-i-get-more-of-it/>

让我们从我最喜欢的约翰·冯·诺依曼的一句话开始:“任何考虑用算术方法产生随机数的人，当然是有罪的。因为，正如已经多次指出的那样，没有随机数这种东西——只有产生随机数的方法，严格的算术程序当然不是这种方法。”

冯·诺依曼的意思是，[伪随机数发生器](https://en.wikipedia.org/wiki/Pseudorandom_number_generator) (PRNG)中的“伪”实际上是“根本不是”的同义词。当然，如果你来到一个好的 PRNG 序列中间，猜测下一个数字几乎是不可能的。但是如果你知道，或者能猜到，T2 的种子 T3 启动了 PRNG，你几乎立刻就能知道所有过去和未来的价值；这是一个纯粹确定的数学函数。这不应该被看作是对 PRNGs 的咆哮，而仅仅是提醒你当你使用一个 PRNGs 时，它吐出的数字的不可猜测性就像种子一样不可猜测。虽然“不可猜测性”不是一个定义明确的数学概念，甚至不是一个真实的词，但*熵*却是。

这就是为什么熵对你很重要。几乎任何你的计算机想要保密的东西都需要在某个时候生成一个秘密随机数，而计算机生成的任何一系列“随机”数都只有和所用种子一样多的熵，因此是不可猜测的。那么，一台计算机，一台确定性的机器，首先是如何为那颗种子获取熵的呢？你如何确保你有足够的钱？你知不知道你的树莓皮可以变成熵的主要来源？请继续阅读！

## 你需要知道的关于熵的一切…

但首先，为了强调冯·诺依曼的观点，这里有一个 PRNG 的算法，它将通过你扔给它的任何统计测试:开始从 1 开始计数整数，散列那个计数器值，将计数器增加 1，将新的计数器值附加到先前的散列，并再次散列它。结果将是一个[散列链](https://en.wikipedia.org/wiki/Hash_chain)，一个看起来完全可预测的“随机”数列——这是 PRNG 的“伪”。如果我知道你在这么做，而且到目前为止你只使用了 100 个左右的数字，我不会花很长时间去做同样的事情，并找出你在这个系列中的位置。如果我只知道你使用相同的算法，但在 1 到 1，000，000 之间的某个地方开始*而不是从 1 开始，我将很难破解你的系列。*

克劳德·香农的熵[概念](https://en.wikipedia.org/wiki/Entropy_(information_theory))本质上是这样的:计算出找出你的秘密所需要的最少的是/否问题的数量。该数字与可能抽取的秘密数的以 2 为底的对数相同，或者等同于用二进制写出可能的秘密数所需的位数。

假设您在哈希链中从 1 开始计数，到目前为止使用的值不超过 128 个。你的 PRNG 机器只有 128 种可能的状态。用二进制表示 128 需要七位， ![\log_2 128 = 7 ](img/127a210a1c3a8029986b0c33420407e7.png) ，如果我开始问你这个数是否大于 64，并且每次细分剩余区间，我只需要猜七次。

熵是对可能的选择数量的一种度量，从这些选择中我们的秘密值可能被提取出来，它是一种测量难以猜测的方法，也是一种测量密码强度的方法，当人们说某个程序产生“有点随机”和“非常随机”的数字时，这就是他们的意思。一个介于 1 到 1，000，000 之间的随机数有不到 20 位的熵。(英语有[大约 100 万个单词](http://www.slate.com/articles/life/the_good_word/2006/04/word_count.html)——你永远不应该输在“二十个问题”上，或者用一个单词作为密码。)一个好的长期密码应该有超过 128 位的熵。

快速测验:如果你从一个好的加密 PRNG 生成一个 256 位的随机数，它将有 256 位的熵，对吗？不对！如果你没有从至少 2 ^(256) 个可能性中完全随机地挑选一个种子，你的数字将会有少于 256 位的熵。所以我们去收获一些熵吧。

## 熵池的最深处

打开电脑，或者启动微控制器。系统中有多少不确定性？它运行的是和你上次启动时完全一样的 BIOS，可能是同样的操作系统和更高的代码。计算机是运行可预测代码的确定性机器。也许挂钟的时间不同，但那是很容易猜到的。这意味着最可靠的随机性来源存在于任何系统管理员都会告诉你的地方——椅子和键盘之间的。

在单板计算机或高性能工作站上的任何 Linux 系统，都从键盘、鼠标、磁盘驱动器或其他硬件事件触发的中断时间戳的最后几个数字中提取熵。假设你不能以微秒的精度重复按键，这可能是相当随机的。这些不同来源的新数据与旧数据混合在一起，每次搅拌都会使锅里的熵值略微增加。

估计每次会增加多少额外的熵是困难的，几乎是不可能的，但是 Linux 内核已经被证明做出了保守的低估。([这曾经是这样做的](https://www.mail-archive.com/cryptography@c2.net/msg01708.html)——有人知道这是否还在吗？)然而，从功能上来说，每次击键或鼠标更新都会给这个池增加一两个比特的熵。这些随着时间的推移而增加，系统还会记录你取出了多少字节。结果就像是熵的气体压力计。

## 我的熵是多少？

反正很容易看出你有多少熵可用，看着它走能学到很多东西。键入`cat /proc/sys/kernel/random/entropy_avail`来看看你的计算机现在已经存储了多少比特的熵。如果一切顺利，它应该接近 3000，但低于 4096 位的最大值——任何大于 256 的值都可以，除非您现在要生成长的 SSH 密钥。

现在让我们实时观察熵的积累。类型:

``watch -n 1 cat /proc/sys/kernel/random/entropy_avail``

 `看到你每秒钟的熵值。一开始什么都不要做，你会看到价值慢慢增加，如果有的话。这可能是磁盘访问或其他系统中断。现在输入或移动你的鼠标，看数字跳跃。例如，我在这个句子的开头有 2886 位，但是现在我得到了 3078 位，仅仅是通过输入。

现在让我们看看是否可以利用一些熵。消耗熵池的第一个也是最简单的方法就是转储内核随机数生成器`/dev/random`中的内容。类型:

`cat /dev/random > random_bits.bin`或`hexdump /dev/random`

在另一个窗口中，当随机值被输出到终端时，观察你的可用熵下降到零。按 ctrl-C 停止疯狂，看看移动鼠标或在键盘上打字将如何重建熵。就是这样。

在实践中，您可能永远不应该这样做。事实上，聚集熵的全部意义在于播下一个好的 PRNG。一旦做到了这一点，除非你有理由相信你的系统受到了损害，否则从池中取出更多的熵就没有什么意义了。这就把我们带到了`/dev/urandom`。

## /dev/天王星

现在打开浏览器到[https://www.hackaday.com](https://www.hackaday.com)，观察可用的熵。熵可能不会下降，尽管我断言 SSL 连接需要生成一个秘密随机数。这是因为任何现代浏览器都使用`/dev/urandom`而不是`/dev/random`作为随机数。`urandom`是一种 PRNG，当系统的熵池包含足够多的估计熵时，它会定期从系统的熵池中重新播种。

由于`/dev/urandom`的输出是一个 PRNG，它只和种子一样好，但是由于种子是从系统熵池中提取的，当它有超过 256 位的熵时(从内核 4.8 开始)，你很难要求更多。由于当熵池中有足够的熵时，这个 PRNG 会定期重新播种，所以即使你的计算机被坏人接管，也很难被利用。

`/dev/random`对`/dev/urandom`有点像 Linux 内核历史上的圣战，对最终用户来说，主要的区别在于`/dev/random`会等到拥有足够的熵后再交付数字，而`/dev/urandom`是一个自由运行的 PRNG，已经从`/dev/random`那里播种，理想情况下拥有足够的熵。这两者之间的差异真正重要的一次是在启动时，在系统中有足够的熵来正确播种`/dev/urandom`中的 PRNG 之前。其余时间，[只用/dev/urandom](https://www.2uo.de/myths-about-urandom/) 。

## 树莓派和硬件 RNG

但是，考虑一下一个独立的、无头的服务器(或微控制器)的命运，没有人打字或鼠标，也没有提供机械不规则性的旋转铁驱动器。启动后 *it* 从哪里得到熵？如果攻击者或运气不好，强制定期重启会怎样？这是一个[真正的问题](http://www.theregister.co.uk/2015/12/02/raspberry_pi_weak_ssh_keys/)。

最简单的答案是内置的硬件随机数生成器。曾经偏执的芯片组硬件产生随机位的权限现在相对普遍。最近的英特尔芯片组本身就支持 [RDRAND](https://en.wikipedia.org/wiki/RdRand) 指令，甚至连 Raspberry Pis 都有一个板载硬件 RNG。让我们来测试一下！

如上所述，您可以使用`cat /proc/sys/kernel/random/entropy_avail`检查 RPi 的可用熵，但是让我们做一些更有戏剧性的事情。尝试从`/dev/random`中获取 1024 字节的随机性，它最多只缓冲 4096 位，即 512 字节。输入`sudo dd if=/dev/random of=/dev/null bs=1024 count=1 iflag=fullblock`,然后等一会儿。然后按`Ctrl-C`，因为你将会等待很长时间，即使你在晃动鼠标。人类熵是很好的熵，但要得到 512 字节的价值需要很长时间。这是每次重启时的情况。您暂时不应该生成 SSH 密钥。

现在让我们得到对系统熵有贡献的硬件 RNG:`sudo apt-get install rng-tools`。您可以在`/etc/default/rng-tools`文件中调整配置。特别是，对于 RPi2，您可能需要取消对`HRNGDEVICE=/dev/hwrng`行的注释。否则，你应该可以走了。重试该命令以转储 1024 字节的随机性:我在 RPi3 上获得了 135 kB/s 的吞吐量——它在 8 毫秒内完成。

即使有了硬件随机数生成器，系统也会混合硬件和人类熵，如果你不完全信任硅黑盒，这是一个好消息。在上面提到的配置文件中，您可以调整不同来源的熵的相对百分比。酷毙了。记住，在一个无头系统中，类似这样的事情的要点只是确保它有足够的熵在程序开始向它请求随机数之前在`/dev/urandom`中播种 PRNG。

您可以很容易地测试硬件 RND 产生的随机数的质量:`rngtest -c 1000 < /dev/hwrng`等待 45 秒左右，将对 2，000，000 位随机数据运行 FIPS 140-2 测试套件。(您需要成为 root 用户才能像这样直接访问`/dev/hwrng`。)

```

root@raspberrypi:/home/pi# rngtest -c 1000 &lt; /dev/hwrng 
rngtest 2-unofficial-mt.14 
Copyright (c) 2004 by Henrique de Moraes Holschuh 
This is free software; see the source for copying conditions. 
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
rngtest: starting FIPS tests... 
rngtest: bits received from input: 20000032 
rngtest: FIPS 140-2 successes: 1000 
rngtest: FIPS 140-2 failures: 0 
rngtest: FIPS 140-2(2001-10-10) Monobit: 0 
rngtest: FIPS 140-2(2001-10-10) Poker: 0 
rngtest: FIPS 140-2(2001-10-10) Runs: 0 
rngtest: FIPS 140-2(2001-10-10) Long run: 0 
rngtest: FIPS 140-2(2001-10-10) Continuous run: 0 
rngtest: input channel speed: (min=476.082; avg=899.493; max=907.881)Kibits/s 
rngtest: FIPS tests speed: (min=7.080; avg=14.217; max=14.352)Mibits/s 
rngtest: Program run time: 23057351 microseconds 

```

这看起来确实像是统计随机数据。当然，输入哈希链的计数器也是如此。但更重要的是，它验证了硬件 RNG 已经启动并运行，没有明显损坏，并且每秒钟产生超过 1 kB 的随机数。这应该能让 Pi 在一毫秒内越过启动时的最初 256 位障碍。如何处理剩余的熵呢？如果你的家庭网络上有一个树莓 Pi，你就有了一个[熵服务器](https://www.vanheusden.com/entropybroker/)，用于任何其他可能运行不了的计算机。或者将数据发布到家庭网络上的 MQTT 主题，您就有了自己的怪异数字站。需要一次性垫吗？`dd if=/dev/hwrng of=hwrng-test-data.bin bs=1024 count=1024`将 1 MB 的甜蜜随机善良转储到一个文件中。

## 外卖食品

伪随机数发生器是确定性函数，只能吐出和种子一样多熵的随机数。获得 256 位熵可能很困难，尤其是在引导时或在没有人交互的无头计算机上。然而，几乎所有时间，Linux 内核都支持你。它是观察你所做的，并把你人类的随机性加入其中，这可能是随机性的最好来源。这就是应该(并且正在)在您的系统上播种 PRNGs 的内容。

对于像 Raspberry Pi 这样的设备，还有一个硬件随机数生成器，可以用来累积熵，以部分弥补人类交互的不足。如果您正在 Pi 上做任何与安全相关的事情，安装`rng-tools`并让它运行起来！`