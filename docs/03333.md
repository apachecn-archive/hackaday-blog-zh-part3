# RGB 发光二极管:如何掌握伽玛和色调的完美亮度

> 原文:[https://hack aday . com/2016/08/23/RGB-LEDs-how-to-master-gamma-and-hue-for-perfect-brightness/](https://hackaday.com/2016/08/23/rgb-leds-how-to-master-gamma-and-hue-for-perfect-brightness/)

你可能会认为对 RGB LEDs 没有什么需要了解的:只需购买一个(一条)带有集成 24 位 RGB 驱动器的 WS2812s，然后开始传输数据。如果你只想制作一些闪亮的东西，而不在乎任何精确的色彩再现或一致的亮度，那就万事俱备了。

但是，如果你想显示视频，用颜色编码数据，或者只是制作一些漂亮的艺术品，你可能需要更努力地思考你正在推动的那些 RGB 值。任何 LED 对脉冲宽度调制(PWM)的响应(几乎)是线性的，当它打开两倍的时间时，会发出两倍的光，但人眼是显著非线性的。你可能已经从一个 LED 案例中了解到这一点，但当你组合红色、绿色和蓝色时，你这样做对吗？

事实证明，即使得到一个褪色的“权利”也是非常棘手的。令人惊讶的是，在过去的二十年里，有关于颜色感知的新科学，尽管眼睛和颜色几乎一直都存在。在这篇短文中，我将努力使事情达到 95%的正确:使黄色、品红色和青色与红色、绿色和蓝色一样明亮。最后，如果你真的想成为极客，我会给你一些指点，让你把最后的 5%做对。如果你准备好让你的 RGB 眼罩更上一层楼，请继续阅读！

## 微克

如果你以前曾经使用脉宽调制(PWM)调暗过单个 LED，你肯定会注意到响应是非线性的。如果占空比从 0%上升到 100%，看起来 LED 在开始时变得非常亮，然后在 50%左右的某个位置完全停止变亮。在 WS2812 上，由于其每色 8 位的分辨率，从红色值 5 到红色值 10 的步进使表观亮度增加了一倍以上，而从 250 到 255 的步进几乎不会被注意到。

然而，这不是 LED 或控制它的 PWM 的问题。[是你的眼睛。](http://www.poynton.com/notes/colour_and_gamma/GammaFAQ.html)。我们使用某种幂定律来感知亮度:如果`B`是感知亮度，而`L`是亮度——穿过你的虹膜的物理光量——关系看起来大致是这样的:

![B = L^\frac{1}{\gamma} \mbox{ or } L = B^\gamma ](../Images/65989a90f0a0766f37f97aa95eb38701.png)

[![brightness_intensity](../Images/9f5f23483a76c32c8664598373e9ad8a.png)](https://hackaday.com/wp-content/uploads/2016/08/brightness_intensity.png) 这种指数关系需要越来越多的额外光线来创造一种可察觉的亮度差异，其特征在于希腊指数:伽马。根据你的直觉，从大约 1.5 到大约 3 的 gamma 值可能是合理的。任意选择 gamma 为 2 会使分数 gamma 指数成为一个更舒适的平方根，并且通常不会错得太多。2.2 是个人电脑领域 CRT 显示器的标准值，1.8 曾经是 MAC 的标准值。

但是，如果你真的关心你的发光二极管的外观，你会想要调整伽马到你的特定条件。我喜欢从黑白摄影的角度考虑选择伽玛。如果我们用一个比你眼睛的自然伽马值更大的值来进行伽马校正，图像会看起来过于对比度-在你想要平滑的地方会有亮度的跳跃。如果伽玛设置低于你的眼睛的伽玛，差异将被减弱，它会看起来模糊。做得恰到好处，你就能在整个范围内实现从暗到亮的平滑过渡。

不过，对微控制器来说，计算一个给定数字的 2.314 次方根是一项艰巨的任务，而且可能有些过头了。最后，我通常将伽马校正作为一个查找表来实现，该表将所需的亮度直接转换为芯片的 PWM 例程想要的任何数字，因此在运行时根本没有数学可言。这里有一个[快速的 Python 脚本](https://gist.github.com/hexagon5un/3df734ad08d8dc8d9ace0491ef97cc58)，它将为您生成查找表。

## 现在是彩色的

[![a-much-larger-version-of-ping-pong-rainbow-display-e1343321856537](../Images/da02d04eb0f0f384285afe0192807fdf.png)](https://hackaday.com/wp-content/uploads/2016/08/a-much-larger-version-of-ping-pong-rainbow-display-e1343321856537.jpg) 伽玛校正可以让你的单色 LED 效果看起来好很多。但是当你从单色升级到 RGB 颜色时会发生什么呢？想象一下，你已经用 WS2812 LED 的红色通道完成了上面的整个伽马实验。现在，您将绿色和蓝色 led 添加到组合中。看起来亮了多少？如果你没有注意上面(打哈欠，数学！)你会说亮三倍。正确答案是 3 的γ次方根。

严格来说，计算亮度取决于所有三个 led 发出的光的混合。好消息是，你还可以用 gammas 计算出任意颜色组合的亮度。公式如下:

![B = \left( R^\gamma + G^\gamma + B^\gamma\right)^\frac{1}{\gamma} ](../Images/54a4877cc1bbc9eb8dc3cebd87598bcf.png)T2】

给定红色、绿色和蓝色的任意比例，您可以使用此公式计算出每个 LED 的 PWM 值，您需要以相同大小的步长使整体颜色变亮或变暗。

### 交叉衰落

[![crossfade_intensity](../Images/ab42fac37b72c3e692d74b957fb821a3.png)](https://hackaday.com/wp-content/uploads/2016/08/crossfade_intensity.png) 上述亮度公式的另一个用途是从一种颜色渐隐到另一种颜色，保持感知亮度不变。例如，要简单地从红色渐变到蓝色，您可以从(255，0，0)开始，通过减去一些红色并添加相同数量的蓝色，向(0，0，255)前进。将这些值代入亮度公式，结果在中间显得明显更暗:低至纯色亮度的 70%左右。不幸的是，这是[几乎所有人](https://www.arduino.cc/en/Tutorial/ColorCrossfader)在线[告诉你的方式](https://learn.adafruit.com/rgb-led-strips/example-code)。这并不意味着这是对的。(又或许他们只是不在乎亮度？)

一个很好的方法来计算出你想要的 RGB LEDs 的伽马值，就是设置一个颜色渐变并调整伽马值，直到整个条带的亮度明显一致。事实上，你只需要三个 led 就可以做到。为了使效果最具戏剧性，它有助于从渐变两端的中等亮度开始:例如，我将使用(70，0，0)和(0，70，0)。中间的 LED 应该是某种黄色，红色和绿色各占一半。调整这些值的数量，直到您认为所有三个 led 的亮度大致相同，然后您就可以计算出您的个人伽玛。

### 调色板和查找表

[![eye-sphere](../Images/dd32df4a905813ca11860b1031f1aa48.png)](https://hackaday.com/wp-content/uploads/2016/08/eye-sphere.jpg) 在一个缓慢的微控制器上，或者在一个 CPU 时间应该做比计算颜色更重要的事情的微控制器上，不断调整亮度的颜色值是不可行的。在单 LED 的情况下，查找表工作良好。但是在 RGB 空间中，需要一个三维数组。对于少量的颜色来说，这仍然是可行的:红色、蓝色和绿色的五个级别产生了一个只有 125 (5 ³ 个条目的调色板。如果你有多余的闪存，你可以随意扩展。

另一种变通方法是先对各个通道进行伽马调整。这样可以获得正确的亮度，但也会影响交叉淡入淡出中色调变化的速率。你可能喜欢这种效果，也可能不喜欢——最好的办法是进行实验。这当然很简单。

## 色彩敏感度和其他细节

对我来说，控制彩色 LED 的亮度大约是战斗的 95%。剩下的 5%用于精确控制色调。也就是说，人类视觉系统有两个怪癖对色彩有影响。

颜色交叉淡化的情况实际上比我想象的要复杂得多；眼睛对每种波长的光并不都一样敏感。如果你将 10 流明的红色、10 流明的绿色和 10 流明的蓝色混合在一起，结果看起来会非常蓝。好消息是，这种效应如此强烈，以至于显示器和 RGB LED 制造商[会为你预先计算每个 LED 发出的光量](http://www.poynton.com/notes/colour_and_gamma/ColorFAQ.html#RTFToC9)。

因此，当您为 RGB LED 指定一个值(10%、10%、10%)时，红色、绿色和蓝色 LED 各有 10%的时间处于开启状态，但绿色 LED 的亮度大约是红色 LED 的三倍，是蓝色 LED 的十倍。所用的 led 会为你处理(粗略的)色彩平衡，所以至少这是你不用担心的一件事。

### 色调的感知均匀性

[![RainbowEdges](../Images/7856bbdc6640c8b979bde9720db4b545.png)](https://hackaday.com/wp-content/uploads/2016/08/rainbowedges.png) 然而，如果你试图用颜色对数值进行编码，你可能会想知道人类感知系统的最后一个怪癖。我们对某些颜色的差异比对其他颜色的差异更敏感。特别是，黄色和青色区域周围的色调对我们来说很容易区分，而不同深浅的红色和蓝色就要困难得多。弄清楚这一点并不容易，尤其是因为我们对一种颜色的感知取决于它周围的颜色。(还记得那件“[白金](http://www.nytimes.com/interactive/2015/02/28/science/white-or-blue-dress.html)”的礼服吗？)

总之，[这里有一个库](https://github.com/FastLED/FastLED/wiki/FastLED-HSV-Colors)，它在解决色调的感知一致性问题上做得非常好，因为它们被限制使用分段线性函数。不过，为了达到这个目的，它们牺牲了一定程度的均匀亮度。

如果你只是需要一些颜色沿着一个感知均匀的颜色渐变， [Color Brewer](http://colorbrewer2.org/) 会支持你。Python 的 matplotlib 将改变其默认的色标，以显著增加感知均匀性和恒定亮度，[这个视频解释了为什么以及如何](https://www.youtube.com/watch?v=xAoljeRJ3lU)对这个主题进行了很好的概述。这并不简单，但至少他们做对了。

最后，如果你真的想深入色彩理论，[这个系列](http://www.handprint.com/LS/CVS/color.html)有比你可能需要知道的更多的细节。

## 结论

你很容易迷失在色彩中，做一点小小的尝试是有趣且值得的。另一方面，只要调整好亮度，你就可以让你的 LED 发光玩具看起来更好，你可以根据你的情况计算出合适的伽马值，并运用一些数学知识。“正确的”gamma 是一个反复试验的问题，但是对于初学者来说，2 左右应该可以。试试吧，让我知道你在评论中的想法。或者更好的是，在你的下一个项目中使用 RGB 伽马校正，并展示给我们大家。