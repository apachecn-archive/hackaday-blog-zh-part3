# 用廉价元件引导运动输入

> 原文:[https://hack aday . com/2015/10/07/bootstrapping-motion-input-with-cheap-components/](https://hackaday.com/2015/10/07/bootstrapping-motion-input-with-cheap-components/)

运动控制是输入技术的一个圣杯。谁不想要一个自己能用简单自然的动作控制的界面呢？但是让用户感觉直观，并让它健壮地工作是需要攀登的巨大山峰。Leap Motion 在制造这种传感器方面做得非常出色，但如何打造自己的传感器呢？这是一个有趣的技巧，它会让你对当前可用的硬件更加欣赏。

让我们搞清楚一件事:这款设备不会像 Leap 控制器那样运行。当然想法是一样的。挥动你的手，控制你的电脑。然而，Leap 是一个相当复杂的设备，我们将使用声纳(或者它真的是 SODAR？)的设备，价格也就几块钱。从好的方面来说，它是非常可定制的，在计算机端完全不需要软件，并且是使用声纳和从 Arduino Leonardo 向 PC 发送键盘命令的一个很好的例子。在这个过程中，我不得不处理低质量的传感器数据，并找出如何扩展 Arduino 来发送默认情况下它不知道的密钥。

### 这个计划

该计划是采用一个廉价的声纳模块(HC-SR04)和一个 Arduino Leonardo，通过模仿用户的键盘输入来执行一些简单的任务。Leonardo 是一个关键元素，因为它是可以轻松模仿 USB 键盘(或鼠标)的 Arduinos 之一。Due、Zero 和 Micro 也可以使用 [Arduino 库](https://www.arduino.cc/en/Reference/MouseKeyboard)来完成。

我想确定我能从 HC-SR04 中真正确定多少手势，然后根据手势做不同的事情。我的第一次尝试只是让 Arduino 检测传感器上的几个手指或一只手，并根据手的上下移动来调整音量。我不知道的是，默认的 Arduino 库不发送多媒体键！稍后会详细介绍。

### 声纳是如何工作的

声纳板有几种风格，但我用的是 4 针。当然，电源和地是一半的引脚。事实上，我早期的测试并不奏效，我最终意识到这个模块需要比我从 Arduino 中获取的更多的能量。我不得不添加一个工作台电源来给模块供电(当然，我也可以用同一个电源给模块和 Arduino 供电)。

另外两个引脚是逻辑信号。一个是输入，一个高电平脉冲导致模块 ping(40k Hz 时 8 个周期)。存在延迟，然后当模块检测到返回 ping 时，另一个引脚(输出)将变为高电平并返回低电平。通过测量您的 ping 信号与返回信号之间的时间，您可以判断距离。在我的例子中，我并不关心实际的距离(尽管这很容易计算)。我只是想知道什么东西是更远还是更近。

[![ping](../Images/346a09f53a60f0155c08f87a5549ab13.png)](https://hackaday.com/wp-content/uploads/2015/10/ping.png) 右边的示波器描迹显示传感器指向相对较近的东西。顶部轨迹是起始脉冲，底部轨迹是 Arduino 的输入。中间的轨迹是声纳传感器的输出。所有信号调理都在传感器内部，因此您无需担心产生和恢复音频的实际信号处理。你只需要测量底部脉冲的宽度。

示波器具有持续性，您可以看到底部轨迹并不总是在同一时间出现(查看下降沿，您可以看到先前样本的“幻影”)。不应该感到惊讶的是，可能需要一点努力来减少从声纳返回的信号的变化。

### 降噪和行动

**平均**

我尝试了几种不同的方法来稳定输入读数。最明显的是对一个以上的样本进行平均。这个想法是，一个或两个偏离很远的样本将被徘徊在某个中心值附近的大多数样本所淘汰。我还发现，有时候你只是错过了——特别是在寻找手指的时候——你会得到一个非常大的数字。我选择丢弃那些与接收到的大部分数据相比看起来差得很远的数据。

**验证**

我使用的另一个策略是用第二次阅读来验证某些元素。例如，当声纳报告一个低于怠速极限的值时，启动事件发生。空闲极限是一个数字，小于当声纳指向天花板(或任何它指向的地方)并且没有任何东西阻挡它时你得到的读数。为了识别有效的开始，代码读取两次以确保该值在限制范围内。

Arduino 循环中的代码本质上是一个状态机。在怠速状态下，它会寻找低于怠速极限的读数。当找到时，会导致转换到采样状态。当读数上升或下降超过某个预设值时，处于样本状态的代码会通过键盘接口发送音量上下键。如果样本超过空闲限制，状态机返回空闲状态。

我通过这种数据简化获得了相当好的结果，但是我也找到了 NewPing 库并安装了它。尽管写出一个脉冲然后读取输入脉冲并不难，但 NewPing 库使它变得更容易(代码也更短)。它还有一个方法 ping_median，也可以进行某种数据过滤和简化。

您可以通过更改文件顶部的 USE_NEW_PING #define 来选择任何一种方法。每种方法都有不同的配置参数，因为这两种方法的返回值略有不同。

我前面说过，代码在检测到动作时会发出调高或调低音量的命令。实际上，主代码并不这样做。它调用一个动作子程序，而这个子程序就是发送按键的子程序。让程序做其他事情也很容易。在这种情况下，它只是打印一些调试信息并发送密钥(见下文)。我没有对实际位置作出反应，尽管动作例程把它作为参数，你可以对它进行操作。例如，您可以让极限位置一次将音量提高两到三步。

### 发送键盘命令

我想把标准的多媒体键发送到电脑上来调节音量。许多键盘已经有了这些，通常你的软件会理解它们，而不需要你的努力。然而，问题是默认的 Arduino 库不知道如何发送它们。

幸运的是，我找到了一篇关于[修改 Arduino 的库](http://stefanjones.ca/blog/arduino-leonardo-remote-multimedia-keys/)以提供一个远程对象的文章，这并不完全符合我的想法，但是可以工作。您可以调用全局远程对象上的方法来做诸如更改音量或静音之类的事情，而不是发送键。这篇文章是针对一个旧版本的 Arduino IDE 的，但是对它进行修改以适应我正在使用的版本(版本 2.1.0.5)并不困难。

对于这个例子，动作例程实际上只需要 UP_IN 和 DN_IN 两种情况。然而，我把所有的四个分支机构都放了进去，以便将来扩张。下面是动作子程序:

```

void action(int why, unsigned value=0)
{
 Serial.print(value);
 switch (why)
 {
 case START_IN:
 Serial.println(&quot; Start&quot;);
 break;
 case STOP_IN:
 Serial.println(&quot; Stop&quot;);
 break;
 case UP_IN:
 Serial.println(&quot; Up&quot;);
 Remote.increase();
 break;
 case DN_IN:
 Serial.println(&quot; Down&quot;);
 Remote.decrease();
 break;
 }
}

```

### 最后的结果

[![sonar](../Images/950e0bfa3700cae2873090cea9477a7a.png)](https://hackaday.com/wp-content/uploads/2015/10/sonar.png) 最终的结果非常好，尽管平均化会使它不如你希望的那样灵敏。你可以调低样本数让它更快，但这样就变得不可靠了。你可以从 Github 下载完整的代码。你要做的第一件事是检查文件的顶部，以确保你的模块是相同的(引脚 3 是触发引脚，引脚 8 是回波返回引脚)。您还需要选择是否要使用 NewPing 库。如果你选择使用它，[你需要安装它](http://playground.arduino.cc/Code/NewPing)。我把我的莱昂纳多翻转过来，用一些适配器把它安装在一块试验板上(见右图)。它真的需要一个更持久的外壳才有用。别忘了给声纳模块自带 5V 电源。

如果你看一下循环函数的顶部，有一个#if 语句阻塞了 3 行代码。将 0 改为 1，您将能够从传感器获得平均数据。把模块放在你想要的地方，看看你会得到什么样的数字。根据我使用的方法，我得到了 4000 到 9000 个指向天花板的点。从 for margin 中减去一点，并将 IDLETHRESHOLD(靠近文件顶部)更改为那个数字。

DELTATHRESHOLD 也是可调的。代码将任何不大于该参数的更改视为无更改。如果你的手颤抖，你可以把它放大；如果你想识别更多的“区域”，你可以把它缩小。然而，阈值越小，系统就越容易受到噪声的影响。样品的显示很有帮助，因为当你的手放在传感器上的某个点时，你可以知道读数变化有多大。你可以试着用一个或两个手指，但是当声音从你手掌的肉质部分反弹时，读数会更可靠。

如果你想添加更多的手势，你可能需要更好地跟踪时间。例如，保持一个(相对)静止的位置一段时间可以是一个手势。要获得真正复杂的手势，您可能需要对输入数据进行一些比简单平均更复杂的过滤。一个[卡尔曼滤波器](https://hackaday.com/2014/11/12/an-external-autofocus-for-dslrs/)可能是多余的，但可能会工作得很好。

如果你环顾四周，许多机器人使用这些传感器来探测障碍物。有道理，它们很便宜，而且效果相当好。也有许多项目使用这些来显示距离的估计(像电子卷尺)。然而，你可以用它们做很多其他的事情。我甚至使用了类似的装置来测量水箱中的液位，本周早些时候，我们看到了用于监测稻田的超声波传感器。

如果你真的想认真对待这个问题，[uglyduck]对这个设备上的虚假读数进行了一些分析。他还重新设计它们，使用不同的处理器，这样他就可以做得更好。这可能有点超出我的意愿，尽管我对 [3D 声波触摸屏](http://hackaday.com/?s=HC-SR04)印象深刻，它也修改了声纳装置。