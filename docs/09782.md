# 保持亲密:一个私人 Git 服务器速成班

> 原文:[https://hack aday . com/2018/06/27/keep-it-close-a-private-git-server-crash-course/](https://hackaday.com/2018/06/27/keep-it-close-a-private-git-server-crash-course/)

至此，大家已经听说微软正在收购 GitHub。这种规模的收购需要时间，但大多数人预计一切将在 2019 年前正式完成。网上的普遍意见似乎令人不安，这是理所当然的。即使我们忽略微软历史上的不正当行为，当一个新的人接管你喜欢的东西时，总会有些不安。有时它最终是有益的，[一个新的更好的时代的开始](https://hackaday.com/2013/07/25/hello-from-supplyframe/)。但是有时候…

[![](../Images/c16cf1a36982eb84f3a3fe0381ffa5fd.png)](https://hackaday.com/wp-content/uploads/2018/06/git1_logo1.png) 我们不要纠结 GitHub 会变成什么样子。虽然 GitHub 是 Git 最流行的基于 web 的接口，但它不是唯一的。例如，GitHub 的完全开源竞争对手 GitLab 报告称，在微软收购的消息被证实后，新的存储库数量创下了纪录。但是，即使是 GitLab，虽然在这个不确定的时期肯定值得一试，但也可能超出了您的严格需求。

让我们现实一点。黑客从事的大多数软件项目甚至不需要 GitHub/GitLab 提供的一半功能。无论您只是想要维护一个私有项目的版本，还是在 hackerspace 环境中与一个小团队合作，您都不需要核心 Git 软件已经提供的任何东西。

让我们来看看如何快速轻松地为您和您的同事建立一个私有 Git 服务器，而不必担心微软(或其他任何人)会染指您的代码。

## 关于遥控器的一句话

首先要理解的是，Git 并不严格使用传统的客户机-服务器类型的安排。例如，没有 Git 服务器，我们有 SSH 和 HTTP 服务器。在 Git 中，有一个被称为`remote`的地方，它是代码被复制和检索的地方。我们大多数人都熟悉提供一个 URL 作为`remote`(指向 GitHub 或其他)，但它也可能是本地系统上的另一个目录，或者是通过网络共享的另一台机器上的目录。它甚至可以是一个 USB 闪存驱动器的挂载点，然后你可以将它物理地移动到其他机器上，使它们在经典的“ [Sneakernet](https://en.wikipedia.org/wiki/Sneakernet) 的现代化版本中保持同步

因此记住这一点，一个基本的“Git 服务器”可以简单到用 NFS 在另一台机器上挂载一个目录，并在本地 Git repo 中将其定义为`remote`。虽然这在必要时肯定会起作用，但普遍接受的方法是使用 SSH 作为本地机器和远程存储库之间的协议。这为您提供了 SSH 的所有优势(压缩、安全性、互联网可路由性等)，同时还易于配置并广泛兼容不同的操作系统。

## 快去战略科研署

我将在 Raspberry Pi 3 上运行的 Raspbian 安装程序上做这件事，但是您选择的 Linux 的[发行版甚至设备都不重要](https://hackaday.com/2013/03/19/carry-a-git-server-in-your-pocket/)。你可以很容易地在你的旧电脑上完成这项任务，但是这项任务对系统的要求很低，这是 Pi 的一个很好的应用。

这里的总体思路是，我们将为 Git 创建一个特定的用户，并使其没有任何 shell 访问权限。我们想要一个 SSH 可以使用的帐户，但是我们不想给它在系统上做任何事情的能力；因为任何使用 Git 服务器的人都必须访问这个帐户。碰巧的是，Git 包含了自己的最小 shell 来完成这个叫做`git-shell`的任务。

然后，我们将为我们的 Git 存储库准备一个地方，创建一个基本的空存储库，并从客户机上验证它是否按预期工作。请记住，这将是一个非常简单的设置，我并不建议您完全按照我在这里所做的去做。这只是为了让您了解如何快速地为自己或一个小组构建一个简单的分布式控制系统，只需使用基本 Git 包中包含的内容。

## 准备用户帐户

假设您已经用如下命令创建了用户“git ”:

`sudo adduser git`

[![](../Images/f1a91aeeb9ccf5997d7602c470b51149.png)](https://hackaday.com/wp-content/uploads/2018/06/git1_shell.png) 下一步是查看`git-shell`是否是您的系统上启用的 shell，如果不是(很可能不是)，就将其添加到有效选项列表中。

最后一行实际上是为用户更改默认 shell 的那一行。如果您现在尝试以“git”身份登录，将会出现一个错误。到目前为止，一切顺利。

只是我们已经有一个问题了。由于“git”用户不能再登录系统，我们不能使用该帐户进行任何后续步骤。为了使事情对你自己更容易，你应该把你自己的帐户添加到“git”组。您很快就会看到，这将使服务器更容易维护。

将用户添加到现有“git”组的命令如下所示:

`sudo usermod -a -G git USERNAME`

## 一个叫做家的地方

[![](../Images/133cb4f9501b32648897baedcf992574.png)](https://hackaday.com/wp-content/uploads/2018/06/git1_perms.png) 您可能倾向于将您的存储库放在“git”用户的主目录中。但是出于安全原因，这个帐户不能做任何事情，所以在它的主目录中放任何东西都没有什么意义。

为了方便起见，您应该在全局可访问的位置(如/opt)创建一个目录，然后更改它的权限，使“git”组拥有完全访问权限。这样，系统上任何属于“git”组的帐户都能够向服务器添加新的存储库。

如果您想跳过这一步，请记住您需要使用`sudo`向服务器添加更多的存储库。如果这是一个一次性的盒子，这不是一个真正的问题，但如果你想让其他一些人使用它，对权限进行更细粒度的控制会很有帮助。

无论如何，一旦创建了想要存储存储库的目录，就该创建一个空白存储库来使用了。这就像创建一个新目录并在其中运行一个 Git 命令一样简单。

[![](../Images/3387d5081a29b6d493140a58dd34605a.png)T2】](https://hackaday.com/wp-content/uploads/2018/06/git1_repocreate.png)

请特别注意最后一行。您需要确保您刚刚创建的存储库的所有者是“git”用户，否则当您试图将代码从客户端推送到服务器时，会出现权限错误。

## 第一次推动

我们现在有了一个 Git 服务器，可以将代码推入其中。从客户端设备，您可以创建一个新的项目来上传，或者将这个服务器设置为现有 Git 存储库的新的`remote`。为了清楚起见，下面是创建一个新的本地 Git 存储库，向其中添加一个文件，然后将其推送到我们的新服务器的样子。 [![](../Images/21bdc33dc0491c63a7426425a6e75622.png)](https://hackaday.com/wp-content/uploads/2018/06/git1_push.png)

注意 git remote add 命令中的用户名和主机名来自我们的服务器系统。如果您的网络上没有域名解析的 DNS 设置，您可以简单地使用此处的 IP 地址。当然，该路径应该看起来很熟悉，因为它是我们之前创建示例存储库的地方。

假设没有错误，您现在已经启动并运行了。您可以从另一台计算机上 git 克隆这个库，随心所欲地推和拉。在将代码推送到新的存储库之前，需要手动添加新的存储库，但是除此之外，工作流程与您所习惯的是一样的。

## 简单的开始

这就是创建您自己的 Git 服务器所需要做的一切，事实上，我们实际上做的比严格要求的要多一些。如果您在一个安全的网络上，并且服务器只供一个人使用，那么您真的可以跳过新用户创建和 shell 替换。只需在您的主目录中创建一个空存储库，并使用您的普通 SSH 凭证。相反，如果您想向一组受信任的合作者开放，那么下一个合乎逻辑的步骤就是设置 SSH 公钥认证，并将他们的密钥添加到系统中。

但是如果你想要更接近公认的时髦的 GitHub 体验呢？好吧，碰巧有许多软件包可以在自托管服务器上提供类似的体验。甚至有一个 GitLab 版本，你可以在一个私有的盒子上运行。[现在我们已经了解了基础知识](https://hackaday.com/2017/05/11/history-of-git/)，我们将在不久的将来看看这些更高级的自托管 Git 选项。