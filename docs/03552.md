# ESP32 动手:令人敬畏的承诺

> 原文:[https://hack aday . com/2016/09/15/esp32-动手-牛逼-承诺/](https://hackaday.com/2016/09/15/esp32-hands-on-awesome-promise/)

ESP32 看起来像一个惊人的芯片，不仅仅是它的价格点。它将 WiFi 和蓝牙无线功能与两个 CPU 内核和一个像样的硬件外设集结合在一起。在售罄之前，在野外有不到 7 美元的模块，它们不会随着时间的推移而变得更贵。鉴于 Espressif 凭借 ESP8266 取得的巨大成功，人们对它的期望很高。

虽然它们在十天前才正式发布，但我们已经有了几个这样的版本。认识身居高位的黑客很有好处——Hackaday super friend[Sprite _ TM]在 Espressif 工作，设法为我们提供了一些模块，并很好地回答了我们的问题。

我们已经阅读了所有的公开文档，并花了一周的时间编写了我们自己的“hello world”示例，以确认一切正常，并在一切不正常的地方根除错误。这些芯片有很多令人喜爱的地方，但固件方面也有很多未知因素，每天都在发生变化。请继续阅读全文。

## 硬件

[![dscf8807_cropped](../Images/f0227dccaa653cce1048ac6edd4a70e6.png)](https://hackaday.com/wp-content/uploads/2016/09/dscf8807_cropped.png) 我们在邮件中收到的是全新 mini 开发板上的两个官方 ESP32 模块( [WROOM-32](http://www.pighixxx.com/test/2016/08/wroom32/) )。(背面的贴纸上手工标注了 2016 年 8 月 31 日，我们是 9 月 4 日在德国收到的，所以你知道它是新鲜的！)开发板将模块的所有引脚分成 0.1”接头，并提供一个 USB-TTL 串行适配器、编程和复位按钮以及一个电源调节器，为 ESP32 提供它渴望的 3.3 V 电压。这足以轻松测试 ESP32，但不会太多。

ESP8266 通过将 WiFi 引入一个小而便宜的封装开始了一场小革命，该封装还具有足够的处理能力和足够的引脚来完成小事情。这个价位也有局限性:处理能力不足以支持快速 WiFi，或者在使用 WiFi 时进行 CPU 密集型活动，GPIOs 太少，一个 ADC 引脚，没有板载 USB。当然，如果你给黑客一套明显的限制，他们最喜欢的就是打破它们。所以我们已经看到了[位碰撞以太网](http://hackaday.com/2016/04/01/ethernet-controller-discovered-in-the-esp8266/)和 [USB](http://hackaday.com/2016/09/03/software-usb-on-the-esp8266/) ，用作 [WiFi 电机控制器](http://hackaday.com/2016/09/06/run-a-reprap-on-an-esp8266/)的 ESP8266，以及更多。但这并没有使限制变得不那么真实，大多数人已经将 ESP8266 与第二个微处理器结合起来，以提供更多的外围选择。

除了 USB 之外，ESP32 解决了这些缺陷中的大部分。我们猜测，他们必须在硅的某个地方画一条线，因为这个芯片是关于无线连接的，USB 没有被切割。奇怪的是，数据手册还列出了以太网 MAC，这与我们的无线假设不符。呸！

### 两个 CPU，都很快

Espressif 加倍了 ESP32 的 CPU 资源。如果你抱怨你不能在旧的 ESP8266 上进行足够的数字运算，那么你可以在 ESP32 上进行大约四倍的运算——两个 CPU 都以 160 MHz 运行，而不是 ESP8266 的(库存)80 MHz。

但你不会在物联网无线芯片上捣鼓数字吧？第二个核心只是为了让你的生活更轻松。例如，显而易见的分工是将一个内核专用于图形或电机控制等实时硬件任务，而另一个内核处理通信。这样的话，你就不必费力地考虑如何安排时间了。但是我们将在下面的 RTOS 部分中更多地讨论双核。

### 外围疯狂

ESP8266 在提供廉价 WiFi 方面表现出色，而 ESP32 似乎正试图成为物联网设备所需的唯一微控制器。这意味着更多的外设、GPIOs 和硬件层面的舒适。

[![esp32_mux](../Images/86e2e407516974d37ac00f6ca2988f4c.png)](https://hackaday.com/wp-content/uploads/2016/09/esp32_mux.png)I/O 部分值得注意。从物理引脚向内，有一个多路复用器，允许多个功能共享该引脚。例如，其中一个路由选择可能导致模拟子部分。有些引脚在 I/O 多路复用器级有专用的硬件外设。不过，最酷的选择是“GPIO ”,它会引出一个矩阵，将任何数字硬件外设连接到该引脚。想要在引脚 13 上接收 UART2 RX？没问题，用代码设置就行了。这将大大有助于缓解外设之间的路由和引脚竞争冲突。

还有大量的硬件外设，其中一些有着有趣的怪癖。例如，PWM 单元可以让您指定不同占空比之间的渐变，一切都由硬件处理。有一个红外 I/O 外设负责编码和解码调制的红外信号。在这两者之间，很有可能会产生奇怪的波形。记住我的话——这些将被滥用于巨大的乐趣。

[![esp32_block](../Images/1fb783aeb5b1ae97b5f329ee235257ce.png)](https://hackaday.com/wp-content/uploads/2016/09/esp32_block.png) 在模拟端，有两个 8 位 DAC 和两个 12 位 ADC，通过 18 个引脚实现多路复用。有一个内置的模拟前置放大器，一个温度传感器，甚至一个霍尔传感器。ESP32 的模拟部分与 ESP8266 的单一 ADC 输入引脚相去甚远。

有三个 UARTs、三个 SPI、两个 i2s 和两个 I2C 总线。所有这些都参与 I/O 矩阵，因此可以路由到任何引脚，但当通过第一级 I/O 多路复用器直接与某些引脚相关联时，它们也能够以更高的速度运行。这看起来像是物理现实和完全灵活性之间有趣的妥协。探索路由可能性和测试这些通信外设的速度是我们要做的事情。

最后，为了支持 WiFi 和加密，现在板载了专用的 AES 和 SHA 外设，因此您可以快速加密和哈希，而无需付出 CPU 代价。

如果你想了解更多关于硬件的信息，你可以在[数据表](https://espressif.com/sites/default/files/documentation/esp32_datasheet_en_0.pdf)和[技术手册](https://espressif.com/sites/default/files/documentation/esp32_technical_reference_manual_en_0.pdf)中阅读。

## 软件

[![dscf8826](../Images/7be6f42ac97fdafb4bceb0da4ca6bf82.png)](https://hackaday.com/wp-content/uploads/2016/09/dscf8826.jpg) 虽然硬件已经是板上钉钉的事情，硅芯片也已经成型，但项目的软件部分仍在进行中。事实上，我们还没有对内置的双通道 8 位 DAC 外设进行深入研究，正是因为我们没有存储器映射或任何头文件来使用它们。但是我们知道它们在那里，因为我们可以在二进制库的字符串转储中看到它们。我们只是还不能接近他们。

Espressif 在这方面迈出了大胆的一步，公开开发了该平台的许多软件部分。新的 ESP32 SDK，被称为“物联网开发框架”(IDF)，以使其与以前的 SDK 相分离，正在 GitHub 上公开开发。在我们使用它的一周内，已经有大约 70 次提交，其中一些解决了我们实际上在芯片上遇到的问题。

这对最终用户来说意味着 IDF 在某种程度上是一个移动的目标。他们还没有推出破坏我的演示程序的代码，但是[Sprite_tm]警告我他们可能会在接下来的几周内推出。另一方面，这也意味着只要 IDF 代码可用，我们就可以访问它，如果我们只对其中的一部分感兴趣，就不必等待整个套件准备就绪。

### RTOS SDK 对 IDF

ESP31 是 ESP32 的开发版本，它有自己的固件开发库: [ESP31_RTOS_SDK](https://github.com/espressif/ESP31_RTOS_SDK) 。这实际上是 RTOS 版 ESP8266 向新芯片的移植。因此，在移植工作中，Espressif 编码人员学到了很多关于新硬件以及旧软件架构如何在其上运行的知识。虽然您可能会被 Espressif 网站上针对 ESP32 的“RTOS 3.0”所迷惑，但它指出了 ESP31 SDK 正在走向渡渡鸟的道路，而 IDF 则是新的热点。

[![esp32_tech](../Images/adc8d921031ace62911c7a2cce3451a8.png)](https://hackaday.com/wp-content/uploads/2016/09/esp32_tech.png)ESP31 和 ESP32 RTOS 库之间的最大区别在于默认情况下两个 CPU 内核的处理方式。在 ESP31 libs 中，一个内核专用于“用户应用”，而另一个专用于通信协议。这是一种强力的非对称多处理，每个内核都有专门的任务。真正的[对称多处理](https://en.wikipedia.org/wiki/Symmetric_multiprocessing)更加灵活，任务切换到目前空闲的 CPU，这就是 IDF 的亮点。对于大多数应用，对称多任务处理可以更好地利用双核。成本？一个巨大的代码返工，以确保任务在核心之间正确切换，一切都很好地配合。

将开放开发与基础架构变化相结合意味着芯片的重要功能，至少就编程的具体细节而言，是不断变化的。例如，就在一周前，你还不能运行 WiFi 并对称地使用两个内核，这是以前非对称策略的遗留问题，但现在你可以了。

Espressif 团队也借此机会修改他们的函数命名约定。一方面，他们将随着时间的推移逐渐发展起来的许多东西合理化。另一方面，你以前知道的函数`wifi_set_opmode()`现在叫做`esp_wifi_set_mode()`。将 ESP8266 代码移植到 ESP32 并不是不可能的，因为操作逻辑非常相似，但是名称的改变会使它在开始时变得很笨拙。(也许一个索引和一个简单的翻译脚本就能解决大部分问题？)

### 什么在起作用？

为了对当前状态有一个合理的了解，可以查看 [components/esp32/include 目录](https://github.com/espressif/esp-idf/tree/master/components/esp32/include)中的头文件。GPIO 和函数矩阵功能齐全，我们已经实际测试过了。有针对实时时钟、AE、SHA、缓冲 UART 的报头，以及针对 SPI 和 I2S 的寄存器定义。有 JSON 代码，mbed 的 TLS 模块的一个端口，lwIP 轻量级 IP 栈，以及更多在[软件栈](https://github.com/espressif/esp-idf/tree/master/components)中的东西。这个列表中明显缺乏的(在编写本报告时)是蓝牙堆栈和许多古怪的外围设备驱动程序。

## 结论是:一辆 ESP8266 黑仔？还没有。

[![pinout_wroom_pinout](../Images/f0a33635750f949415ce4b5f2b45ed7f.png)](https://hackaday.com/wp-content/uploads/2016/09/pinout_wroom_pinout.png) 现在，如果我们有一个需要 WiFi 连接的项目，我们想尽快完成，我们仍然会从抽屉里拿出一个 ESP8266。ESP32 IDF 仍然太粗糙，无法快速完成项目。另一方面，我们对有一对夫妇一起玩感到非常兴奋，尤其是因为我们只是喜欢在性感的新芯片的内存图中闲逛，看看它们能做什么。我们都知道将会发生什么——几个月后，芯片将拥有完整的 Arduino 和/或 NodeMCU 处理能力，甚至 noobs 也将使用这一器件编写 WiFi 和蓝牙应用。(我们等不及了！)

将大量物理 I/O 和各种硬件外围设备与无线技术结合在一起真是太棒了。我们看到的每个将 ESP8266 与另一个微控制器芯片相连的项目都证明了这一事实。Arduino Uno WiFi 板和 T2 Arduino/genu ino mkr 1000 板也试图通过将微控制器安装到 WiFi 模块上来利用这一优势。如果 ESP32 能够独立运行，提供我们渴望的无线连接，并且只需很少的钱，同时得到易于使用的社区图书馆的广泛支持，它将会像野火一样畅销。

### 下一步是什么？

所以我们手里有两个这样的人，一个在 Espressif 的内线，我们只是触及了表面。接下来，我们将看看真实世界的功耗，这将意味着切割一些迹线和焊接一些绿线。在那之后，我们可能会处理多处理器编码，或者研究 TLS 功能或蓝牙栈。你对 ESP32 有什么迫切的问题？请在评论中告诉我们，我们会尽最大努力给你答案。