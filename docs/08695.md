# 风暴探测器模块介绍

> 原文:[https://hack aday . com/2018/03/22/an-introduction-to-storm-detector-modules/](https://hackaday.com/2018/03/22/an-introduction-to-storm-detector-modules/)

令人惊讶的是，雷暴探测器已经存在了很长时间。早期的设计包括一对金属钟和一个钟摆。当施加电荷时，例如将一个钟连接到地面，另一个连接到避雷针，当雷雨临近时，钟就会响。在 18 世纪中期的 T2，这些设备仅仅用于演示和研究，但很可能代表了最早的将静电荷转化为机械力的设备。一百多年后，第一个闪电探测器被一些人认为是[第一个无线电接收器](http://en.wikipedia.org/wiki/Alexander_Stepanovich_Popov#Demonstrations)。

当我发现风暴探测器芯片时，我知道我必须让它工作。我花了大约 25 美元从中国订购了一个 AMS AS3935 模块。这种芯片以前已经在许多优秀的项目中出现过，如推特闪电探测器和撒哈拉以南的 T2 气象站网络。虽然有一个 Arduino 库用于与该 IC 接口，但我将把它连接到运行 NodeMCU 固件的 ESP8266，这意味着深入研究数据手册并编写一些 SPI 代码。如果以上任何一条引起了你的兴趣，请继续阅读！

[![](../Images/1018476caf529a1c910cae4dc3dd15a2.png)T2】](https://hackaday.com/wp-content/uploads/2018/03/lightning_detector_recto_square.jpg)

与最早的电荷探测器不同，[这种探测器的工作原理是使用一个 500 kHz 的小天线拾取远距离雷击产生的射频信号](http://en.wikipedia.org/wiki/Lightning_detection)，并进行一些数字信号处理。

该探测器能够区分雷击和其他类型的射频噪声，然后使用来自雷击的信号来估计到风暴前沿的距离，最远可达 40 公里。这非常好，有两个原因:它可以在比你用眼睛和耳朵更远的地方探测到活跃的风暴，它可以让你合理地知道风暴的到来速度。

很容易想到可能的应用。高尔夫球场、运动场、游泳池和海滩都将受益于更早的风暴探测。除了户外活动，数据中心、机场和施工人员也需要了解即将到来的雷电风暴。

就我而言，我住在东南亚，雨季可能有点像史诗。倾盆大雨是非常局部的，难以置信的强烈，经常导致洪水，并且几乎没有警告就发生。像大多数居民一样，我骑摩托车，在大雨中被堵在路上或高速公路上是很痛苦的。如果有选择，通常最好停下来，喝杯咖啡，然后让它过去。

天气预报对计划旅行不是很有用，因为大多数阵雨都是局部的、短暂的、频繁的。整个雨季的天气预报只是每天“28 摄氏度，75%的可能性有阵雨”，所以给我的摩托车加一个风暴探测器似乎很实用，也很有趣。即使它只在某些时候有效，那也是很棒的。事实上，我很惊讶我从来没有把这当成一个产品——如果它有效，请有人这样做。

## 去实验室！

回到我们的探测器，有一个 [Arduino 库](http://github.com/PlayingWithFusion/PWFusion_AS3935_I2C)与它接口，如果这是你的风格的话。它看起来很容易使用，但我个人更喜欢使用 NodeMCU 和 ESP8266，尽管它没有针对该芯片的内置库。

幸运的是，我们有 AS3935 的[数据表](http://www.mouser.com/ds/2/588/ams_AS3935_Datasheet_EN_v5-1214568.pdf) (PDF)，芯片支持 SPI 和 I2C 接口。我一直在寻找一个借口来探索 NodeMCU 上 Lua 中的 SPI，这是完美的。由于我们只是使用普通 SPI，希望代码也能更容易移植到其他平台。

[![](../Images/516fc5525cbf9d44d7cb3157ced9e548.png)](https://hackaday.com/wp-content/uploads/2018/03/lightning_detector_verso_square.jpg) 让我们从基本设置开始。数据手册指出，要使用 SPI，需要将选择接口(SI)引脚拉至地。我还想使用片内稳压器，因此需要将 EN_V 芯片拉高。最后，芯片在每次检测到事件时将中断引脚拉高，让相连的微控制器知道发生了有趣的事情。

为了提高此引脚的抗扰度，我使用了一个 1kω下拉电阻接地(下面未显示)。后者可能是不必要的，但有助于减少测试期间在没有外壳的情况下处理电路时的假阳性。

![](../Images/8b77aabac79840a7c6ddb0fc1f971be6.png)

Default pins for SPI 1\. Source: [NodeMCU Documentation](https://nodemcu.readthedocs.io/en/master/en/modules/spi/)

接下来，我们连接 SPI 所需的所有引脚。有 4 个:主机输出从机输入(MOSI)、主机输入从机输出(MISO)、时钟(SCK)和片选(CS)。我在 NodeMCU 下包含了一个小表，详细说明了这些引脚是什么，请记住，它们在其他平台上可能会有所不同。

重要的一点是，在 SPI 通信期间，CS 引脚不由 NodeMCU 自动管理。您需要像设置其他 GPIO 引脚一样设置它的值，我们将在后面介绍。在你开始编程之前，我强烈建议你仔细检查你所有的管脚是否连接正确。我就这样浪费了一个小时，觉得自己很傻。

我们首先初始化 SPI 和相关引脚:

```

spi.setup(1, spi.MASTER, spi.CPOL_LOW, spi.CPHA_LOW, 8, 256);
CS=8
IRQ = 2
gpio.mode(CS, gpio.OUTPUT)
gpio.mode(IRQ, gpio.INPUT)
```

在 NodeMCU 上，SPI 0 用于与板载闪存通信，因此我们选择了 SPI 1，它具有大多数默认功能，每个数据项 8 位。值得注意的是，我们在 SPI 频率上设置了 256 的时钟分频器。这是因为 AS3935 支持 2 Mhz 的最大 SPI 频率，NodeMCU 默认为更快的速度(至少 20 Mhz)。注意，芯片不应设置为 500 kHz 的 SPI 频率，因为这是闪电探测器天线的谐振频率。).

我们还将芯片选择引脚设置为 D8 的输出，并将中断引脚(IRQ)连接为输入。IRQ 将在每个新事件发生时升高，并保持高电平，直到您读取中断寄存器来确定事件类型。在 NodeMCU 上使用它作为适当的中断或触发器并不可靠，所以我们现在只能使用普通的输入引脚。

根据数据手册，读取和写入 AS3935 需要通过 SPI 发送 8 个字节。前两位决定您是请求读还是写，接下来的六位决定目标寄存器。如果从芯片读取，首先需要将 CS 设为低电平以启动读取(发送请求前)，然后在完成后将 CS 设为高-低-高电平。让我们扩展程序，在芯片每次输出一个事件时读取中断寄存器:

```
function reason()
    gpio.write(CS, gpio.LOW)
    tmr.delay(30)

    spi.send(1,0x43)
    tmr.delay(30)

    read = spi.recv(1, 8)
    print(string.byte(read))
    gpio.write(CS, gpio.HIGH)
    tmr.delay(30)
    gpio.write(CS, gpio.LOW)
    tmr.delay(30)
    gpio.write(CS, gpio.HIGH)
    tmr.delay(30)
end

function poll()
    x = gpio.read(IRQ)
    if x == 1
        then reason()
    end

    tmr.alarm(1, 100, 1, function() poll(0) end)
end

```

在上面的代码中，我们每隔 100 毫秒轮询一次 IRQ 引脚，看看它是否为高电平。如果是这样，我们将 CS 设置为低，以表示我们将要请求读取。然后我们发送命令 0x43，它翻译成二进制 01000011。前两位(01)请求读取，后六位(000011)表示我们想要读取寄存器地址 0x03。响应的最后四位将包含检测到的事件类型。发送命令后，我们从 SPI 端口读取 8 位并打印结果，最后将 CS 引脚设置为高-低-高，以表示读取完成。

上述代码的结果是一个不规则的“4”(0100)流到终端。如果我触摸天线，它会输出“1”。查看数据手册，0100 的中断原因是“干扰”:目标频率的无线电信号，但不是闪电。在亚洲大城市，附近总有人在电弧焊；当夜间航班到达时，它像下面的星星一样闪烁。中断原因 0001 意味着高电气噪声的问题，这也是有道理的。一次闪电事件会输出‘8’(1000)，但是现在是旱季，所以这在这个时候不太可能。

我们现在可以成功地从设备接收数据，但它还不是特别有用。下一次，我们将讨论如何写入配置寄存器，以使其更实际地工作，并通过我们对数据的处理获得一些创造性的乐趣。